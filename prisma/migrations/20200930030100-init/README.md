# Migration `20200930030100-init`

This migration has been generated by woony at 9/30/2020, 12:01:00 PM.
You can check out the [state of the schema](./schema.prisma) after the migration.

## Database Steps

```sql
ALTER TABLE `Message` DROP FOREIGN KEY `Message_ibfk_1`

ALTER TABLE `Message` DROP FOREIGN KEY `Message_ibfk_2`

ALTER TABLE `Message` DROP COLUMN `fromname`,
    DROP COLUMN `touserId`,
    ADD COLUMN `fromUserId` varchar(191)  NOT NULL ,
    ADD COLUMN `roomId` varchar(191)  NOT NULL ,
    ADD COLUMN `toUserId` varchar(191)  NOT NULL 

CREATE TABLE `Room` (
`createdAt` datetime(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
`id` varchar(191)  NOT NULL ,
`updatedAt` datetime(3)  NOT NULL DEFAULT CURRENT_TIMESTAMP(3),
PRIMARY KEY (`id`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

CREATE TABLE `_RoomParticipants` (
`A` varchar(191)  NOT NULL ,
`B` varchar(191)  NOT NULL ,
UNIQUE INDEX `_RoomParticipants_AB_unique`(`A`,
`B`),
INDEX `_RoomParticipants_B_index`(`B`)
) DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_unicode_ci

ALTER TABLE `_RoomParticipants` ADD FOREIGN KEY (`A`) REFERENCES `Doctor`.`Room`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `_RoomParticipants` ADD FOREIGN KEY (`B`) REFERENCES `Doctor`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Message` ADD FOREIGN KEY (`fromUserId`) REFERENCES `Doctor`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Message` ADD FOREIGN KEY (`roomId`) REFERENCES `Doctor`.`Room`(`id`) ON DELETE CASCADE ON UPDATE CASCADE

ALTER TABLE `Message` ADD FOREIGN KEY (`toUserId`) REFERENCES `Doctor`.`User`(`id`) ON DELETE CASCADE ON UPDATE CASCADE
```

## Changes

```diff
diff --git schema.prisma schema.prisma
migration 20200920104410-init..20200930030100-init
--- datamodel.dml
+++ datamodel.dml
@@ -4,15 +4,15 @@
 }
 datasource db {
   provider = "mysql"
-  url = "***"
+  url = "***"
 }
 model HomeAD {
   id        String    @id @default(cuid())
   createdAt DateTime  @default(now())
-  updatedAt DateTime  @updatedAt @default(now())
+  updatedAt DateTime  @default(now()) @updatedAt
   expireAt  DateTime?
   imageUrl String
   url      String
@@ -20,9 +20,9 @@
 model User {
   id        String   @id
   createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
   avatar         String?
   password       String
   name           String
@@ -38,17 +38,18 @@
   Post    Post[]    @relation("PostAuthor")
   Comment Comment[] @relation("CommentAuthor")
   inbox   Message[] @relation("MessageReceiver")
   outbox  Message[] @relation("MessageSender")
+  rooms   Room[]    @relation(name: "RoomParticipants")
   @@unique([medical_id, medical_cate])
 }
 model Post {
   id        String   @id @default(cuid())
   user      User     @relation(name: "PostAuthor", fields: [userId], references: [id])
   userId    String
-  updatedAt DateTime @updatedAt @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
   createdAt DateTime @default(now())
   category   String
   title      String
@@ -62,18 +63,18 @@
   id        String   @id @default(cuid())
   user      User     @relation(name: "CommentAuthor", fields: [userId], references: [id])
   userId    String
   createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
   text   String
   post   Post   @relation(fields: [postId], references: [id])
   postId String
 }
 model Product {
   id        String    @id @default(cuid())
-  updatedAt DateTime  @updatedAt @default(now())
+  updatedAt DateTime  @default(now()) @updatedAt
   createdAt DateTime  @default(now())
   expireAt  DateTime?
   mainCategory String
@@ -92,9 +93,9 @@
 model sampleImage {
   id        String   @id @default(cuid())
   createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
   url       String
   productId String
   product   Product @relation(fields: [productId], references: [id])
@@ -102,9 +103,9 @@
 model detailImage {
   id        String   @id @default(cuid())
   createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
   url       String
   productId String
   product   Product @relation(fields: [productId], references: [id])
@@ -112,23 +113,32 @@
 model likeProduct {
   id        String   @id @default(cuid())
   createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt @default(now())
+  updatedAt DateTime @default(now()) @updatedAt
   userId    String
   user      User    @relation(fields: [userId], references: [id])
   productId String
   product   Product @relation(fields: [productId], references: [id])
 }
+model Room {
+  createdAt    DateTime  @default(now())
+  id           String    @id @default(cuid())
+  updatedAt    DateTime  @default(now()) @updatedAt
+  messages     Message[]
+  participants User[]    @relation(name: "RoomParticipants", references: [id])
+}
+
 model Message {
-  id        String   @id @default(cuid())
-  createdAt DateTime @default(now())
-  updatedAt DateTime @updatedAt
-
-  text     String
-  fromname String
-  touserId String
-  from     User   @relation("MessageSender", fields: [fromname], references: [id])
-  to       User   @relation("MessageReceiver", fields: [touserId], references: [id])
+  createdAt  DateTime @default(now())
+  fromUserId String
+  id         String   @id @default(cuid())
+  roomId     String
+  text       String
+  toUserId   String
+  updatedAt  DateTime @updatedAt
+  from       User     @relation("MessageSender", fields: [fromUserId], references: [id])
+  room       Room     @relation(fields: [roomId], references: [id])
+  to         User     @relation("MessageReceiver", fields: [toUserId], references: [id])
 }
```


